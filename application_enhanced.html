<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1000px; margin: 0 auto; background: white; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .content { padding: 40px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="number"],
        textarea, select {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 16px; transition: border-color 0.3s;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; }
        textarea { resize: vertical; min-height: 120px; }
        input[type="file"] {
            padding: 10px; border: 2px dashed #e0e0e0; border-radius: 8px; width: 100%; cursor: pointer;
        }
        .file-info { margin-top: 8px; font-size: 14px; color: #666; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 15px 40px; border: none; border-radius: 8px;
            font-size: 18px; font-weight: 600; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s; width: 100%;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); margin-top: 10px; }
        .btn-record { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-submit { background: linear-gradient(135deg, #28a745 0%, #218838 100%); }
        .message { margin-top: 20px; padding: 15px; border-radius: 8px; display: none; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .tabs { display: flex; margin-bottom: 30px; }
        .tab {
            flex: 1; padding: 15px; text-align: center; background: #f5f5f5; cursor: pointer;
            border-bottom: 3px solid transparent; transition: all 0.3s; font-size: 14px;
        }
        .tab:hover { background: #e0e0e0; }
        .tab.active { background: white; border-bottom-color: #667eea; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .audio-player { margin-top: 20px; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #667eea;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 20px auto; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .question-card { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea; }
        .question-number { font-weight: bold; color: #667eea; margin-bottom: 10px; }
        .question-text { font-size: 16px; margin-bottom: 15px; color: #333; }
        .evaluation-card { background: #fff; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #e0e0e0; }
        .score-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-weight: bold; margin-right: 10px; }
        .score-excellent { background: #d4edda; color: #155724; }
        .score-good { background: #d1ecf1; color: #0c5460; }
        .score-average { background: #fff3cd; color: #856404; }
        .score-poor { background: #f8d7da; color: #721c24; }
        .evaluation-section { margin-top: 20px; }
        .evaluation-section h3 { color: #667eea; margin-bottom: 10px; }
        .evaluation-section ul { list-style-position: inside; line-height: 1.8; }
        .progress-indicator { text-align: center; margin-bottom: 20px; font-size: 18px; color: #667eea; font-weight: 600; }
        .hidden { display: none; }
        
        /* ===================== ENHANCED LIVE INTERVIEW STYLES ===================== */
        
        /* Progress Container */
        .progress-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 15px;
        }
        
        .progress-label {
            font-size: 18px;
            font-weight: 600;
        }
        
        .progress-percentage {
            font-size: 24px;
            font-weight: bold;
        }
        
        .progress-bar-outer {
            height: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-bar-inner {
            height: 100%;
            background: white;
            border-radius: 10px;
            width: 25%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }
        
        /* Enhanced Video Container */
        .video-container-enhanced {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto 30px;
            border-radius: 20px;
            overflow: hidden;
        }
        
        .video-glow-ring {
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, #667eea, #764ba2, #667eea);
            border-radius: 25px;
            opacity: 0;
            transition: opacity 0.3s;
            animation: rotate 3s linear infinite;
            z-index: -1;
        }
        
        .video-glow-ring.active {
            opacity: 0.7;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        video {
            width: 100%;
            display: block;
            background: #000;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .recording-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(220, 53, 69, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        
        .rec-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }
        
        .rec-text {
            color: white;
            font-weight: 600;
            font-size: 12px;
            letter-spacing: 1px;
        }
        
        /* Enhanced Question Card */
        .question-card-enhanced {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #667eea;
            position: relative;
            overflow: hidden;
        }
        
        .question-card-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        }
        
        .question-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .question-icon {
            font-size: 28px;
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .question-label {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .question-text-enhanced {
            font-size: 20px;
            line-height: 1.6;
            color: #333;
            font-weight: 500;
            min-height: 60px;
        }
        
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        /* Audio Visualizer */
        .audio-player-enhanced {
            margin-top: 20px;
        }
        
        .audio-visualizer {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 60px;
            gap: 4px;
            padding: 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
        }
        
        .audio-bar {
            width: 6px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            animation: audioWave 1s ease-in-out infinite;
        }
        
        .audio-bar:nth-child(1) { height: 20%; animation-delay: 0s; }
        .audio-bar:nth-child(2) { height: 40%; animation-delay: 0.1s; }
        .audio-bar:nth-child(3) { height: 60%; animation-delay: 0.2s; }
        .audio-bar:nth-child(4) { height: 80%; animation-delay: 0.3s; }
        .audio-bar:nth-child(5) { height: 70%; animation-delay: 0.4s; }
        .audio-bar:nth-child(6) { height: 50%; animation-delay: 0.5s; }
        .audio-bar:nth-child(7) { height: 30%; animation-delay: 0.6s; }
        .audio-bar:nth-child(8) { height: 10%; animation-delay: 0.7s; }
        
        @keyframes audioWave {
            0%, 100% { height: 20%; }
            50% { height: 100%; }
        }
        
        /* Enhanced Status Card */
        .status-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .status-card.listening {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9fa 0%, #e3e7fc 100%);
        }
        
        .status-icon-container {
            position: relative;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pulse-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid #667eea;
            border-radius: 50%;
            opacity: 0;
        }
        
        .pulse-ring.active {
            animation: pulsate 2s ease-out infinite;
        }
        
        @keyframes pulsate {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }
        
        .status-icon {
            font-size: 48px;
            z-index: 1;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .status-content {
            flex: 1;
        }
        
        .status-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .sound-wave-enhanced {
            display: flex;
            justify-content: flex-start;
            align-items: flex-end;
            height: 40px;
            gap: 5px;
        }
        
        .wave-bar-enhanced {
            width: 8px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            animation: waveMove 1s ease-in-out infinite;
        }
        
        .wave-bar-enhanced:nth-child(1) { height: 30%; animation-delay: 0s; }
        .wave-bar-enhanced:nth-child(2) { height: 50%; animation-delay: 0.1s; }
        .wave-bar-enhanced:nth-child(3) { height: 80%; animation-delay: 0.2s; }
        .wave-bar-enhanced:nth-child(4) { height: 60%; animation-delay: 0.3s; }
        .wave-bar-enhanced:nth-child(5) { height: 40%; animation-delay: 0.4s; }
        
        @keyframes waveMove {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }
        
        /* Enhanced Transcript Card */
        .transcript-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid #e0e0e0;
        }
        
        .transcript-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .transcript-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .transcript-title {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            flex: 1;
        }
        
        .word-count {
            font-size: 14px;
            color: #666;
            background: #f8f9fa;
            padding: 5px 15px;
            border-radius: 15px;
        }
        
        .transcript-content {
            min-height: 120px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .transcript-text-enhanced {
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .placeholder-text {
            color: #999;
            font-style: italic;
        }
        
        .transcript-footer {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .confidence-meter {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .confidence-label {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
        }
        
        .confidence-bar-outer {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .confidence-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease-out;
        }
        
        .confidence-value {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
            min-width: 40px;
            text-align: right;
        }
        
        /* Tips Panel */
        .tips-panel {
            background: linear-gradient(135deg, #e3e7fc 0%, #f8f9fa 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px dashed #667eea;
        }
        
        .tip-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .tip-item:last-child {
            border-bottom: none;
        }
        
        .tip-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .tip-text {
            font-size: 14px;
            color: #555;
            line-height: 1.5;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .progress-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .status-card {
                flex-direction: column;
                text-align: center;
            }
            
            .transcript-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); opacity: 0.7; }
            50% { transform: scaleY(1); opacity: 1; }
        }
        
        .evaluation-result { background: #f8f9fa; padding: 30px; border-radius: 15px; margin-top: 20px; }
        .score-display { font-size: 72px; font-weight: bold; color: #667eea; text-align: center; margin: 30px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Job Application Portal</h1>
            <p>Submit your application and complete the interview</p>
        </div>

        <div class="content">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('application')">Application</div>
                <div class="tab" onclick="switchTab('interview')">Interview</div>
                <div class="tab" onclick="switchTab('liveInterview')">Pre Screen Interview</div>
            </div>

            <!-- =================== APPLICATION TAB =================== -->
            <div id="application" class="tab-content active">
                <form id="jobApplicationForm">
                    <div class="form-group">
                        <label for="fullName">Full Name *</label>
                        <input type="text" id="fullName" name="full_name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email Address *</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="position">Position Applied For *</label>
                        <select id="position" name="position" required>
                            <option value="">Select a position</option>
                            <option value="Software Engineer">Software Engineer</option>
                            <option value="Frontend Developer">Frontend Developer</option>
                            <option value="Backend Developer">Backend Developer</option>
                            <option value="Full Stack Developer">Full Stack Developer</option>
                            <option value="Data Scientist">Data Scientist</option>
                            <option value="Product Manager">Product Manager</option>
                            <option value="UI/UX Designer">UI/UX Designer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="coverLetter">Cover Letter</label>
                        <textarea id="coverLetter" name="cover_letter" placeholder="Tell us why you're a great fit..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="resume">Resume (PDF, DOC, DOCX) *</label>
                        <input type="file" id="resume" name="resume" accept=".pdf,.doc,.docx" required>
                        <div class="file-info" id="fileInfo"></div>
                    </div>
                    <button type="submit">Submit Application</button>
                </form>
                <div class="loader" id="loader"></div>
                <div class="message" id="message"></div>
            </div>

            <!-- =================== INTERVIEW TAB =================== -->
            <div id="interview" class="tab-content">
                <div id="questionGeneratorSection">
                    <h2>Generate Interview Questions</h2>
                    <form id="questionGeneratorForm" onsubmit="event.preventDefault(); GenerateQuestions();">
                        <button type="submit">Generate Questions</button>
                    </form>
                    <div class="loader" id="questionLoader"></div>
                    <div class="message" id="questionMessage"></div>
                </div>

                <div id="answerQuestionsSection" style="display: none;">
                    <div class="progress-indicator" id="progressIndicator"></div>
                    <form id="answerQuestionsForm">
                        <div id="questionsContainer"></div>
                    </form>
                    <div class="loader" id="answerLoader"></div>
                    <div class="message" id="answerMessage"></div>
                </div>

                <div id="evaluationSection" style="display: none;">
                    <h2>üìä Interview Evaluation Results</h2>
                    <div id="evaluationResults"></div>
                    <button type="button" class="btn-secondary" onclick="resetInterview()">Take Another Interview</button>
                </div>
            </div>

            <!-- =================== ENHANCED LIVE INTERVIEW TAB =================== -->
            <div id="liveInterview" class="tab-content">
                <div id="startSection">
                    <h2>üé§ Start Your Pre-Screen Interview</h2>
                    <p style="margin-bottom: 20px; color: #666;">Resume-Based Interview with Real-Time Emotion Analysis</p>
                    <div id="liveInterviewInfo" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <p id="currentAppId" style="font-weight: bold; color: #667eea;"></p>
                    </div>
                    <button onclick="startLiveInterview()" id="startLiveBtn" disabled>Start Pre-Screen Interview</button>
                </div>

                <div id="liveInterviewSection" class="hidden">
                    <!-- Enhanced Progress Bar -->
                    <div class="progress-container">
                        <div class="progress-header">
                            <span class="progress-label" id="liveProgressText">Question 1 of 4</span>
                            <span class="progress-percentage" id="progressPercentage">25%</span>
                        </div>
                        <div class="progress-bar-outer">
                            <div class="progress-bar-inner" id="progressBarInner"></div>
                        </div>
                    </div>

                    <!-- Enhanced Video Container with Glow Effect -->
                    <div class="video-container-enhanced">
                        <div class="video-glow-ring" id="videoGlowRing"></div>
                        <video id="videoElement" autoplay muted></video>
                        <div class="recording-indicator" id="recordingIndicator">
                            <span class="rec-dot"></span>
                            <span class="rec-text">LIVE</span>
                        </div>
                    </div>

                    <!-- Enhanced Question Display with Animation -->
                    <div class="question-card-enhanced">
                        <div class="question-header">
                            <span class="question-icon">üí¨</span>
                            <span class="question-label">Interview Question</span>
                        </div>
                        <div class="question-text-enhanced" id="liveQuestionText">
                            <span class="typing-indicator">
                                <span></span><span></span><span></span>
                            </span>
                        </div>
                        <div class="audio-player-enhanced">
                            <audio id="questionAudio" style="display: none;"></audio>
                            <div class="audio-visualizer" id="audioVisualizer">
                                <div class="audio-bar"></div>
                                <div class="audio-bar"></div>
                                <div class="audio-bar"></div>
                                <div class="audio-bar"></div>
                                <div class="audio-bar"></div>
                                <div class="audio-bar"></div>
                                <div class="audio-bar"></div>
                                <div class="audio-bar"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Status Indicator with Better Animations -->
                    <div class="status-card" id="statusCard">
                        <div class="status-icon-container" id="statusIconContainer">
                            <div class="pulse-ring" id="pulseRing"></div>
                            <div class="status-icon" id="statusIcon">üéôÔ∏è</div>
                        </div>
                        <div class="status-content">
                            <p class="status-title" id="statusText">Waiting for question...</p>
                            <div class="sound-wave-enhanced" id="soundWave" style="display: none;">
                                <div class="wave-bar-enhanced"></div>
                                <div class="wave-bar-enhanced"></div>
                                <div class="wave-bar-enhanced"></div>
                                <div class="wave-bar-enhanced"></div>
                                <div class="wave-bar-enhanced"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Transcript Display -->
                    <div class="transcript-card">
                        <div class="transcript-header">
                            <div style="display: flex; align-items: center;">
                                <span class="transcript-icon">‚úçÔ∏è</span>
                                <span class="transcript-title">Your Answer (Real-time)</span>
                            </div>
                            <span class="word-count" id="wordCount">0 words</span>
                        </div>
                        <div class="transcript-content">
                            <p class="transcript-text-enhanced" id="transcriptText">
                                <span class="placeholder-text">Start speaking to see your response transcribed...</span>
                            </p>
                        </div>
                        <!-- <div class="transcript-footer">
                            <div class="confidence-meter">
                                <span class="confidence-label">Confidence:</span>
                                <div class="confidence-bar-outer">
                                    <div class="confidence-bar-inner" id="confidenceBar"></div>
                                </div>
                                <span class="confidence-value" id="confidenceValue">--</span>
                            </div>
                        </div> -->
                    </div>

                    <!-- Interactive Tips Panel -->
                    <!-- <div class="tips-panel" id="tipsPanel">
                        <div class="tip-item">
                            <span class="tip-icon">üí°</span>
                            <span class="tip-text">Speak clearly and at a moderate pace</span>
                        </div>
                        <div class="tip-item">
                            <span class="tip-icon">‚è∏Ô∏è</span>
                            <span class="tip-text">The system detects 2.5 seconds of silence to move forward</span>
                        </div>
                        <div class="tip-item">
                            <span class="tip-icon">üéØ</span>
                            <span class="tip-text">Stay focused and be yourself</span>
                        </div>
                    </div> -->

                    <div id="liveLoader" class="loader hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        const MCQ_API_URL = 'http://localhost:8080';
        let currentSessionId = null;
        let currentApplicationId = null;
        let currentQuestions = [];
        let liveSessionId = null;
        let videoStream = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let currentQuestionNumber = 1;
        let totalQuestions = 4;
        let recognition = null;
        let isListening = false;
        let silenceTimer = null;
        let isProcessing = false;
        let currentTranscript = '';
        let finalTranscript = '';
        let resumeFile = null;
        let applicantName = '';
        let applicantEmail = '';
        let applicantPosition = '';
        let currentQuestionIndex = 0;
        let answers = [];
        let timerInterval;
        let cQ = null;

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        document.getElementById('resume').addEventListener('change', function(e) {
            const file = e.target.files[0];
            resumeFile = file;
            const fileInfo = document.getElementById('fileInfo');
            if (file) fileInfo.textContent = `Selected: ${file.name} (${(file.size / (1024*1024)).toFixed(2)} MB)`;
        });

        document.getElementById('jobApplicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const loader = document.getElementById('loader');
            const message = document.getElementById('message');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            loader.style.display = 'block';
            message.style.display = 'none';
            submitBtn.disabled = true;
            const formData = new FormData(e.target);
            try {
                const response = await fetch(`${API_BASE_URL}/api/job-application`, { method: 'POST', body: formData });
                const data = await response.json();
                if (response.ok) {
                    currentApplicationId = data.application_id;
                    applicantName = formData.get('full_name');
                    applicantEmail = formData.get('email');
                    applicantPosition = formData.get('position');
                    
                    sessionStorage.setItem('applicationState', JSON.stringify({
                        applicationId: data.application_id,
                        name: applicantName,
                        email: applicantEmail,
                        position: applicantPosition
                    }));
                    
                    message.className = 'message success';
                    message.textContent = `‚úì ${data.message}! Application ID: ${data.application_id}. You can now proceed to the Interview tabs.`;
                    e.target.reset(); 
                    document.getElementById('fileInfo').textContent = '';
                    document.getElementById('startLiveBtn').disabled = false;
                    document.getElementById('currentAppId').textContent = `Your Application ID: ${data.application_id}`;
                    
                    GetQuestions();
                } else {
                    message.className = 'message error';
                    message.textContent = data.error || 'Application submission failed.';
                }
            } catch(err) { 
                message.className='message error'; 
                message.textContent='Error submitting application.'; 
            }
            loader.style.display = 'none'; 
            submitBtn.disabled = false;
            message.style.display = 'block';
        });

        function resetInterview() {
            document.getElementById('answerQuestionsSection').style.display = 'none';
            document.getElementById('evaluationSection').style.display = 'none';
            document.getElementById('questionGeneratorSection').style.display = 'block';
            document.getElementById('questionsContainer').innerHTML = '';
            document.getElementById('progressIndicator').textContent = '';
            currentQuestionIndex = 0;
            answers = [];
            clearInterval(timerInterval);
        }

        function showQuestion(index) {
            const question = currentQuestions[index];
            const progress = `Question ${index + 1} of ${currentQuestions.length}`;
            document.getElementById('progressIndicator').textContent = progress;

            const container = document.getElementById('questionsContainer');
            container.innerHTML = `
                <div class="question-card">
                    <div class="question-number">${progress}</div>
                    <div class="question-text">${question.question}</div>
                    <div id="timer" style="font-size: 24px; color: red; text-align: center; margin: 10px 0;">10</div>
                    <div class="options">
                        ${question.options.map((option, i) => `
                            <label style="display: block; margin: 5px 0;">
                                <input type="radio" name="q${index}" value="${i}" onchange="selectAnswer(${index}, ${i})">
                                ${option.option}
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;

            startTimer();
        }

        function startTimer() {
            let timeLeft = 10;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = timeLeft;
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    nextQuestion();
                }
            }, 1000);
        }

        function selectAnswer(questionIndex, optionIndex) {
            answers[questionIndex] = optionIndex;
            clearInterval(timerInterval);
            setTimeout(() => nextQuestion(), 1000);
        }

        function nextQuestion() {
            clearInterval(timerInterval);
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
            } else {
                submitQuiz();
            }
        }

        async function submitQuiz() {
            const results = currentQuestions.map((question, index) => ({
                question_id: index + 1,
                selected_option: answers[index] || 0,
                is_correct: question.options[answers[index] || 0]?.is_correct || false,
                time_taken_seconds: 10
            }));

            const submission = {
                applicant_info: {
                    name: applicantName,
                    email: applicantEmail,
                    position: applicantPosition,
                    application_id: currentApplicationId
                },
                results: results
            };

            const loader = document.getElementById('answerLoader');
            const message = document.getElementById('answerMessage');
            loader.style.display = 'block';
            message.style.display = 'none';

            try {
                const response = await fetch(`${MCQ_API_URL}/submit-quiz`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submission)
                });

                const data = await response.json();

                if (response.ok) {
                    window.location.href = 'thank_you.html';
                } else {
                    message.className = 'message error';
                    message.textContent = data.detail || 'Failed to submit quiz.';
                    message.style.display = 'block';
                }
            } catch (error) {
                message.className = 'message error';
                message.textContent = 'Error submitting quiz.';
                message.style.display = 'block';
            } finally {
                loader.style.display = 'none';
            }
        }

        async function GetQuestions() {
            if (!resumeFile) return;

            const formData = new FormData();
            formData.append('name', applicantName || 'Test Name');
            formData.append('email', applicantEmail || 'test@example.com');
            formData.append('position', applicantPosition || 'ML Engineer');
            formData.append('resume', resumeFile);

            try {
                const response = await fetch(`${MCQ_API_URL}/generate-quiz`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok && data.questions) {
                    cQ = data;
                }
            } catch (error) {
                console.error('Error prefetching questions:', error);
            }
        }

        async function GenerateQuestions() {
            if (!resumeFile) {
                alert('Please upload a resume first in the Application tab!');
                return;
            }

            const loader = document.getElementById('questionLoader');
            const message = document.getElementById('questionMessage');
            loader.style.display = 'block';
            message.style.display = 'none';

            if (cQ != null && cQ.questions) {
                currentQuestions = cQ.questions;
                document.getElementById('questionGeneratorSection').style.display = 'none';
                document.getElementById('answerQuestionsSection').style.display = 'block';
                loader.style.display = 'none';
                showQuestion(0);
            } else {
                await GetQuestions();
                
                if (cQ != null && cQ.questions) {
                    currentQuestions = cQ.questions;
                    document.getElementById('questionGeneratorSection').style.display = 'none';
                    document.getElementById('answerQuestionsSection').style.display = 'block';
                    loader.style.display = 'none';
                    showQuestion(0);
                } else {
                    message.className = 'message error';
                    message.textContent = 'Failed to generate questions. Please try again.';
                    message.style.display = 'block';
                    loader.style.display = 'none';
                }
            }
        }

        // ==================== ENHANCED LIVE INTERVIEW FUNCTIONS ====================
        
        function updateProgress(questionNum, total) {
            const percentage = (questionNum / total) * 100;
            document.getElementById('liveProgressText').textContent = `Question ${questionNum} of ${total}`;
            document.getElementById('progressPercentage').textContent = `${Math.round(percentage)}%`;
            document.getElementById('progressBarInner').style.width = `${percentage}%`;
        }

        function updateStatus(text, showWave, icon = 'üéôÔ∏è') {
            document.getElementById('statusText').textContent = text;
            document.getElementById('statusIcon').textContent = icon;
            const soundWave = document.getElementById('soundWave');
            const statusCard = document.getElementById('statusCard');
            const pulseRing = document.getElementById('pulseRing');
            const videoGlow = document.getElementById('videoGlowRing');
            
            if (showWave) {
                soundWave.style.display = 'flex';
                statusCard.classList.add('listening');
                pulseRing.classList.add('active');
                videoGlow.classList.add('active');
            } else {
                soundWave.style.display = 'none';
                statusCard.classList.remove('listening');
                pulseRing.classList.remove('active');
                videoGlow.classList.remove('active');
            }
        }

        function updateWordCount(text) {
            const words = text.trim().split(/\s+/).filter(w => w.length > 0);
            document.getElementById('wordCount').textContent = `${words.length} words`;
        }

        function updateConfidenceBar(confidence) {
            const confidenceBar = document.getElementById('confidenceBar');
            const confidenceValue = document.getElementById('confidenceValue');
            confidenceBar.style.width = `${confidence}%`;
            confidenceValue.textContent = `${Math.round(confidence)}%`;
        }

        async function startLiveInterview() {
            if (!currentApplicationId) { 
                alert('Please submit application first.'); 
                return; 
            }
            
            document.getElementById('startSection').style.display = 'none';
            document.getElementById('liveInterviewSection').classList.remove('hidden');
            updateProgress(1, totalQuestions);
            
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('videoElement').srcObject = videoStream;
            } catch (error) {
                alert('Error accessing microphone/camera: ' + error.message);
                return;
            }
            
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onstart = () => {
                    isListening = true;
                    updateStatus('üéôÔ∏è Listening...', true, 'üé§');
                };
                
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let newFinalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            newFinalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    if (newFinalTranscript) {
                        finalTranscript += newFinalTranscript;
                        currentTranscript = finalTranscript;
                    }
                    
                    const displayText = finalTranscript + interimTranscript;
                    const transcriptEl = document.getElementById('transcriptText');
                    
                    if (displayText.trim()) {
                        transcriptEl.innerHTML = displayText;
                        updateWordCount(displayText);
                        
                        // Update confidence based on speech length
                        const confidence = Math.min(100, (displayText.length / 5));
                        updateConfidenceBar(confidence);
                    }
                    
                    if (newFinalTranscript || interimTranscript) {
                        resetSilenceTimer();
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    if (event.error === 'no-speech') {
                        if (finalTranscript.trim().length > 0) {
                            handleSilence();
                        }
                    } else if (event.error !== 'aborted') {
                        updateStatus('‚ùå Speech recognition error: ' + event.error, false, '‚ùå');
                    }
                };
                
                recognition.onend = () => {
                    if (isListening && !isProcessing) {
                        setTimeout(() => {
                            if (isListening && !isProcessing) {
                                try {
                                    recognition.start();
                                } catch (e) {
                                    console.log('Recognition restart:', e.message);
                                }
                            }
                        }, 100);
                    }
                };
            } else {
                alert('Speech recognition not supported in this browser. Please use Chrome or Edge.');
                return;
            }
            
            await loadNextLiveQuestion();
        }

        function resetSilenceTimer() {
            clearTimeout(silenceTimer);
            silenceTimer = setTimeout(() => {
                if (isListening && finalTranscript.trim().length > 0 && !isProcessing) {
                    handleSilence();
                }
            }, 2500);
        }

        async function handleSilence() {
            if (isProcessing || !finalTranscript.trim()) {
                return;
            }
            
            isProcessing = true;
            isListening = false;
            updateStatus('üîÑ Processing your answer...', false, '‚è≥');
            
            if (recognition) {
                recognition.stop();
            }
            
            const audioBase64 = await stopAudioRecording();
            await submitLiveAnswer(finalTranscript.trim(), audioBase64);
            
            finalTranscript = '';
            currentTranscript = '';
            const transcriptEl = document.getElementById('transcriptText');
            transcriptEl.innerHTML = '<span class="placeholder-text">Start speaking to see your response transcribed...</span>';
            updateWordCount('');
            updateConfidenceBar(0);
        }

        async function loadNextLiveQuestion() {
            const loader = document.getElementById('liveLoader');
            const questionText = document.getElementById('liveQuestionText');
            const questionAudio = document.getElementById('questionAudio');
            
            loader.classList.remove('hidden');
            updateStatus('üîÑ Loading question...', false, '‚è≥');
            isProcessing = true;
            
            // Show typing indicator
            questionText.innerHTML = '<span class="typing-indicator"><span></span><span></span><span></span></span>';
            
            try {
                let response;
                if (currentQuestionNumber === 1) {
                    response = await fetch(`${API_BASE_URL}/api/interview/start`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ application_id: currentApplicationId })
                    });
                } else {
                    return;
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    liveSessionId = data.session_id;
                    
                    // Animate question appearance
                    setTimeout(() => {
                        questionText.textContent = data.question;
                    }, 500);
                    
                    updateProgress(data.question_number, data.total_questions);
                    
                    if (data.audio) {
                        const audioBlob = base64ToBlob(data.audio, 'audio/mpeg');
                        const audioUrl = URL.createObjectURL(audioBlob);
                        questionAudio.src = audioUrl;
                        
                        questionAudio.play().then(() => {
                            questionAudio.onended = () => {
                                startListening();
                            };
                        }).catch(err => {
                            console.error('Error playing audio:', err);
                            startListening();
                        });
                    } else {
                        startListening();
                    }
                } else {
                    alert('Error loading question: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error starting interview: ' + error.message);
            } finally {
                loader.classList.add('hidden');
            }
        }

        function startListening() {
            if (!recognition) return;
            
            isListening = true;
            isProcessing = false;
            updateStatus('üéôÔ∏è Listening for your answer...', true, 'üé§');
            
            finalTranscript = '';
            currentTranscript = '';
            const transcriptEl = document.getElementById('transcriptText');
            transcriptEl.innerHTML = '<span class="placeholder-text">Start speaking to see your response transcribed...</span>';
            updateWordCount('');
            updateConfidenceBar(0);
            
            startAudioRecording();
            
            try {
                recognition.start();
                resetSilenceTimer();
            } catch (error) {
                console.log('Recognition start:', error.message);
                if (error.message.includes('already')) {
                    resetSilenceTimer();
                }
            }
        }

        function startAudioRecording() {
            if (!videoStream) return;
            
            try {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                
                audioChunks = [];
                const audioStream = new MediaStream(videoStream.getAudioTracks());
                mediaRecorder = new MediaRecorder(audioStream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onerror = (error) => {
                    console.error('MediaRecorder error:', error);
                };
                
                mediaRecorder.start(1000);
                isRecording = true;
            } catch (error) {
                console.error('Error starting audio recording:', error);
            }
        }

        async function stopAudioRecording() {
            return new Promise((resolve) => {
                if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                    resolve(null);
                    return;
                }
                
                mediaRecorder.onstop = async () => {
                    isRecording = false;
                    if (audioChunks.length > 0) {
                        try {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const audioBase64 = await blobToBase64(audioBlob);
                            resolve(audioBase64);
                        } catch (error) {
                            console.error('Error converting audio to base64:', error);
                            resolve(null);
                        }
                    } else {
                        resolve(null);
                    }
                };
                
                mediaRecorder.stop();
            });
        }

        async function submitLiveAnswer(answerText, audioBase64 = null) {
            if (!liveSessionId || !answerText) {
                console.error('Missing session ID or answer text');
                isProcessing = false;
                return;
            }
            
            const loader = document.getElementById('liveLoader');
            loader.classList.remove('hidden');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/interview/continue`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: liveSessionId,
                        answer_text: answerText,
                        audio_blob_base64: audioBase64
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.is_final) {
                        displayEvaluationResults(data.evaluation);
                    } else {
                        currentQuestionNumber = data.question_number;
                        
                        const questionText = document.getElementById('liveQuestionText');
                        questionText.innerHTML = '<span class="typing-indicator"><span></span><span></span><span></span></span>';
                        
                        setTimeout(() => {
                            questionText.textContent = data.question;
                        }, 500);
                        
                        updateProgress(data.question_number, data.total_questions);
                        
                        if (data.audio) {
                            const audioBlob = base64ToBlob(data.audio, 'audio/mpeg');
                            const audioUrl = URL.createObjectURL(audioBlob);
                            const questionAudio = document.getElementById('questionAudio');
                            questionAudio.src = audioUrl;
                            
                            questionAudio.play().then(() => {
                                questionAudio.onended = () => {
                                    startListening();
                                };
                            }).catch(err => {
                                console.error('Error playing audio:', err);
                                startListening();
                            });
                        } else {
                            startListening();
                        }
                    }
                } else {
                    alert('Error submitting answer: ' + (data.detail || 'Unknown error'));
                    startListening();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error submitting answer: ' + error.message);
                startListening();
            } finally {
                loader.classList.add('hidden');
            }
        }

        function displayEvaluationResults(evaluation) {
            try { 
                if (recognition) { 
                    recognition.stop(); 
                } 
            } catch(_) {}
            
            isListening = false;
            
            if (videoStream) { 
                videoStream.getTracks().forEach(t => t.stop()); 
            }
            
            const start = document.getElementById('startSection');
            const live = document.getElementById('liveInterviewSection');
            
            if (live) live.classList.add('hidden');
            if (start) start.style.display = 'block';

            alert('Thanks! Your pre-screen interview is complete. Our team will review your results and get back to you.');
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        window.addEventListener('load', function() {
            const savedState = sessionStorage.getItem('applicationState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    currentApplicationId = state.applicationId;
                    applicantName = state.name;
                    applicantEmail = state.email;
                    applicantPosition = state.position;
                    
                    if (state.applicationId) {
                        document.getElementById('currentAppId').textContent = `Your Application ID: ${state.applicationId}`;
                        document.getElementById('startLiveBtn').disabled = false;
                    }
                } catch (e) {
                    console.error('Error restoring state:', e);
                }
            }
            
            const hash = window.location.hash.substring(1);
            if (hash && (hash === 'application' || hash === 'interview' || hash === 'liveInterview')) {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                const tabs = document.querySelectorAll('.tab');
                const tabNames = ['application', 'interview', 'liveInterview'];
                const tabIndex = tabNames.indexOf(hash);
                if (tabIndex !== -1) {
                    tabs[tabIndex].classList.add('active');
                    document.getElementById(hash).classList.add('active');
                }
            }
        });
    </script>
</body>
</html>
